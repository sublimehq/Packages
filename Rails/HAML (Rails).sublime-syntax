%YAML 1.2
# https://haml.info/docs/yardoc/file.REFERENCE.html
---
name: HAML (Rails)
scope: text.haml
version: 2

file_extensions:
  - haml
  - sass

contexts:

  main:
    - include: comments
    - include: doctypes
    - include: tags
    - include: escapes
    - include: rubylines
    - include: continuations
    - include: text-interpolations

  comments:
    # https://haml.info/docs/yardoc/file.REFERENCE.html#comments
    # haml comments
    - match: ^ *(-#)\s*\S.*$\n?
      scope: comment.line.slash.haml
      captures:
        1: punctuation.definition.comment.haml
    - match: ^( *)(-#)\s*$
      captures:
        2: punctuation.definition.comment.haml
      push: comment-body
    # html comments
    - match: ^( *)(/)((\[)[^\]]*(\]))?\s*$
      captures:
        2: punctuation.definition.comment.haml
        3: meta.brackets.haml
        4: punctuation.section.brackets.begin.haml
        5: punctuation.section.brackets.end.haml
      push: comment-body
    - match: ^ *(/)((\[)[^\]]*(\]))?\s*\S.*$\n?
      scope: comment.line.slash.haml
      captures:
        1: punctuation.definition.comment.haml
        2: meta.brackets.haml
        3: punctuation.section.brackets.begin.haml
        4: punctuation.section.brackets.end.haml

  comment-body:
    - meta_scope: comment.block.haml
    - match: ^(?!\1  )
      pop: 1
    - include: main

  continuations:
    # Attribute sections and embedded ruby code may continue on next line
    # if the current line is terminated with comma.
    # https://haml.info/docs/yardoc/file.REFERENCE.html#attributes
    # https://haml.info/docs/yardoc/file.REFERENCE.html#running-ruby--
    - match: (,)\n
      captures:
        1: punctuation.separator.sequence.haml
      push: comma-continuations-body
    # https://haml.info/docs/yardoc/file.REFERENCE.html#multiline
    - match: (\|)\s*\n
      captures:
        1: punctuation.separator.continuation.haml
      push: pipe-continuations-body

  comma-continuations-body:
    # Skip "line ends with pipe" check if previous line was continued by comma.
    - match: (?=\S)
      pop: 1

  pipe-continuations-body:
    - match: ^
      pop: 1

  doctypes:
    # https://haml.info/docs/yardoc/file.REFERENCE.html#doctype-
    - match: ^(!!!)(\s+(.*)\s*)?$
      scope: meta.doctype.haml
      captures:
        1: punctuation.definition.doctype.haml
        2: constant.language.doctype.haml

  escapes:
    - match: ^\s*(\\.)
      captures:
        1: meta.escape.haml

  text-interpolations:
    # Interpolation without clearing `string` scope for use in plain text.
    # https://haml.info/docs/yardoc/file.REFERENCE.html#ruby-interpolation-
    - match: \#\{
      scope: punctuation.section.interpolation.begin.haml
      push: text-interpolation-expression
    - match: (?=#[@$])
      push: text-interpolation-variable

  text-interpolation-expression:
    - meta_scope: meta.interpolation.haml
    - meta_content_scope: source.ruby.embedded.haml
    - match: \}
      scope: punctuation.section.interpolation.end.haml
      pop: 1
    - include: Ruby (for HAML).sublime-syntax#nest-curly-expressions
    - include: Ruby (for HAML).sublime-syntax#expressions

  text-interpolation-variable:
    - meta_scope: meta.interpolation.haml
    - include: Ruby (for HAML).sublime-syntax#interpolated-ruby-variables

  rubylines:
    - match: ^\s*(=|-|~)
      scope: punctuation.section.embedded.haml
      push: rubyline-body

  rubyline:
    - match: (=|-|~)
      scope: punctuation.section.embedded.haml
      set: rubyline-body

  rubyline-body:
    - meta_scope: meta.embedded.haml meta.line.ruby.haml
    - meta_content_scope: source.ruby.embedded.haml
    - match: ((do|\{)( \|[^|]+\|)?)$
      captures:
        1: source.ruby.embedded.html
        2: keyword.control.start-block.ruby
      pop: 1
    - include: ruby-code

  ruby-code:
    - match: $
      pop: 1
    # A line after a pipe-continuation must be terminated by pipe, too.
    - match: ^(?!.*(\|\s*$))
      pop: 1
    - include: Ruby (for HAML).sublime-syntax
      apply_prototype: true

  tags:
    - match: ^\s*(?:((%)([\w:]+))|(?=\.|#))
      captures:
        1: meta.tag.haml
        2: punctuation.definition.tag.haml
        3: entity.name.tag.haml
      push: tag-content

  tag-content:
    - match: (\.)[\w-]+
      scope: meta.tag.haml entity.name.tag.class.haml
      captures:
        1: punctuation.definition.tag.haml
    - match: (#)[\w-]+
      scope: meta.tag.haml entity.name.tag.id.haml
      captures:
        1: punctuation.definition.tag.haml
    - match: \{(?=.*\}|.*(,|\|\s*)$)
      scope: punctuation.section.braces.begin.haml
      push: tag-attributes-content
    - match: \[(?=.*\]|.*(,|\|\s*)$)
      scope: punctuation.section.brackets.begin.haml
      push: tag-object-content
    - include: rubyline
    - match: /
      scope: punctuation.terminator.tag.haml
    - match: '[<>]'
      scope: keyword.operator.whitespace.haml
    - match: ''
      pop: 1

  tag-attributes-content:
    - meta_scope: meta.tag.attributes.haml meta.braces.haml
    - match: \}(?!.*\})
      scope: punctuation.section.braces.end.haml
      pop: 1
    - include: ruby-code

  tag-object-content:
    - meta_scope: meta.tag.object.haml meta.brackets.haml
    - match: \](?!.*\])
      scope: punctuation.section.brackets.end.haml
      pop: 1
    - include: ruby-code

