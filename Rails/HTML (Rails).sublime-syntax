%YAML 1.2
---
name: HTML (Rails)
scope: text.html.rails
version: 2

extends: Packages/HTML/HTML.sublime-syntax

file_extensions:
  - rails
  - rhtml
  - erb
  - html.erb

contexts:

###[ CUSTOM HTML ]############################################################

  prototype:
    - meta_prepend: true
    - include: rails-embedded

  strings-common-content:
    - meta_prepend: true
    - include: rails-interpolations

  tag-attribute-value-content:
    - meta_prepend: true
    - include: rails-interpolations

  script-javascript-content:
    - meta_include_prototype: false
    - match: (?=\S)
      embed: scope:source.js.rails
      embed_scope: source.js.embedded.html
      escape: '{{script_close_lookahead}}'

  style-css-content:
    - meta_include_prototype: false
    - match: ''
      embed: scope:source.css.rails
      embed_scope: source.css.embedded.html
      escape: '{{style_close_lookahead}}'

  tag-event-attribute-value:
    - match: \"
      scope:
        meta.string.html string.quoted.double.html
        punctuation.definition.string.begin.html
      embed: scope:source.js.rails
      embed_scope:
        meta.string.html meta.interpolation.html
        source.js.embedded.html
      escape: \"
      escape_captures:
        0: meta.string.html string.quoted.double.html
           punctuation.definition.string.end.html
    - match: \'
      scope:
        meta.string.html string.quoted.single.html
        punctuation.definition.string.begin.html
      embed: scope:source.js.rails
      embed_scope:
        meta.string.html meta.interpolation.html
        source.js.embedded.html
      escape: \'
      escape_captures:
        0: meta.string.html string.quoted.single.html
           punctuation.definition.string.end.html
    - include: else-pop

  tag-style-attribute-value:
    - match: \"
      scope:
        meta.string.html string.quoted.double.html
        punctuation.definition.string.begin.html
      embed: scope:source.css.rails#rule-list-body
      embed_scope:
        meta.string.html meta.interpolation.html
        source.css.embedded.html
      escape: \"
      escape_captures:
        0: meta.string.html string.quoted.double.html
           punctuation.definition.string.end.html
    - match: \'
      scope:
        meta.string.html string.quoted.single.html
        punctuation.definition.string.begin.html
      embed: scope:source.css.rails#rule-list-body
      embed_scope:
        meta.string.html meta.interpolation.html
        source.css.embedded.html
      escape: \'
      escape_captures:
        0: meta.string.html string.quoted.single.html
           punctuation.definition.string.end.html
    - include: else-pop

###[ EMBEDDED RUBY ]##########################################################

  rails-interpolations:
    - match: (?=<%)
      push: rails-interpolation-content

  rails-interpolation-content:
    - clear_scopes: 1
    - meta_include_prototype: false
    - meta_scope: meta.interpolation.html
    - include: rails-embedded
    - include: immediately-pop

  rails-embedded:
    - match: <%+#
      scope: punctuation.definition.comment.begin.rails
      push: rails-comment-content
    - match: <%+(?!>)[-=]?
      scope: meta.embedded.rails punctuation.section.embedded.begin.rails
      embed_scope: meta.embedded.rails source.ruby.embedded.rails
      embed: Ruby (Rails).sublime-syntax
      escape: -?%>
      escape_captures:
        0: meta.embedded.rails punctuation.section.embedded.end.rails

  rails-comment-content:
    - meta_include_prototype: false
    - meta_scope: comment.block.rails
    - match: \%>
      scope: punctuation.definition.comment.end.rails
      pop: 1
